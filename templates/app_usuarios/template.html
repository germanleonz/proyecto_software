<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    {% load staticfiles %}
    {% load dajaxice_templatetags %}
    {% dajaxice_js_import %}
    <title>{% block titulo %}Proyecto de pizarras{% endblock titulo%}</title>
    <link href="{% static "css/template_style.css" %}" rel="stylesheet" type="text/css"/>
    <link href="{% static "css/pared_style.css" %}" rel="stylesheet" type="text/css"/>
    <link href="{% static "css/style_dialog.css" %}" rel="stylesheet" type="text/css"/>
    <script type="text/javascript" src="{% static "javascript/jquery-1.8.2.min.js"%}"></script>
    <script type="text/javascript" src="{% static "javascript/jquery-ui-1.9.1.custom.min.js"%}"></script>
    <script type="text/javascript" src="{% static "javascript/jquery-ui-1.9.1.custom.js"%}"></script>
    {% block css %}{% endblock css %}
    {% block javascript %}
    <script>
      function my_js_callback(data){
        document.getElementById("formPizarra").innerHTML = data.vista;
      }
    </script>
    {% endblock javascript %}
  </head>

  <body>
  <div id="borde">
      <div id="header">
        <a href="{% url login_usuario %}"><img id="logo" src="{% static "images/logo_front.png" %}"/></a>

        {% block rightHeader %}
        {% if user.is_authenticated %}
        <div id="nombre">
          {{user.first_name}} {{user.last_name}}
        </div>
        {% endif %}
        {% endblock rightHeader %}
      </div>

      <div id="main">

        {% block herramientas %}
        <script>
          function my_js_callback(data){
            document.getElementById("formPizarra").innerHTML = data.vista;
          }
        </script>
        <script>
          $(document).ready(function(){
            $("#nombre").click(function(){
              $("#opcionesUsuario").show();
            });
            $(document).keyup(function(event) {
              if(event.which === 27) {
                $('#opcionesUsuario').hide();
              }
            });
            $(document).mouseup(function (e)
            {
              var container = $("#opcionesUsuario");
              if (container.has(e.target).length === 0)
              {
                container.hide();
              }
            });
          });
        </script>

        <div id="herramientas">
          <a id="crearPizarra" onclick="Dajaxice.app_pizarras.crearPizarraForm(my_js_callback);" class="opcionesDer" href="#">Nueva Pizarra</a>

          {% block botones %}{% endblock botones %}
        </div>
        {% endblock herramientas %}
        <div id="opcionesUsuario">
          <div class="opcionVer"><a href="{% url app_pizarras:listar_pizarra %}">Mis pizarras</a></div>
          <div class="opcionVer">
            <form action="{% url app_usuarios:modificar_perfil %}" method="post">
              {% csrf_token %}
              <input type="hidden" name="nombre" value={{user.first_name}}/>
              <input type="hidden" name="apellido" value={{user.last_name}}/>
              <input type="hidden" name="correo" value={{user.email}}/>
              <input class="submits" type="submit" value="Editar Perfil">
            </form>
          </div>
          <div class="opcionVer"><a href="{% url app_usuarios:logout_view %}">Cerrar Sesion</a></div>
        </div>

        <div id="formPizarra" style="display:none;"></div>
        {% block cuerpo %}
        {% endblock cuerpo %}
<!-- Script de dialog para crear pizarra-->
<script>
  $("#crearPizarra").click(function(){
    $("#formPizarra").dialog({
      modal:true,
      position: { my: "center", at: "top", of: window },
      dialogClass: 'style_Dialog',
      title: "Registrar Pizarra",
      buttons: {
        "Crear Pizarra": function(){
          var nombre = $("#id_nombre"),
              descripcion = $("#id_descripcion"),
              fechaini = $("#id_fecha_inicio"),
              fechafin = $("#id_fecha_final"),
              valido = true,
              formato = /^[A-Za-z0-9\?\¿\!\¡\:\,\.\-\ç\ñáéíóú\(\)\"\'\äëïöüàèìòù\s]*$/;

              /*Chequeo de largo de inputs*/
              function checkLength(obj, name, min, max){
                var valido = true;
                if (obj.val().length == 0){
                  valido = false;
                }
                else if (obj.val().length<min){
                  valido = false;
                }
                else if (obj.val().length>max){
                  valido = false;
                }
                
                if (!valido){
                  $("#errores_crear_pizarra").html("*"+name+" debe tener entre "+min+" y "+max+" caracteres");
                }

                return valido;
              }

              /*Chequeo de regex en inputs*/
              function checkRegex(obj, name, regex){
                if (!regex.test(obj.val())){
                  $("#errores_crear_pizarra").html("*"+name+" no es valido");
                  return false;
                }
                return true;
              }
              /*chequear formato de fecha*/
              function isDate(obj) {
                var valido = true;
                var fecha = obj.val(), dia, mes, anio;
                if (fecha.length !== 10) { 
                  valido = false;
                } 
                // third and sixth character should be '/' 
                if (fecha.substring(2, 3) !== '/' || fecha.substring(5, 6) !== '/') { 
                  valido = false;
                } 

                dia = parseInt(fecha.substring(0,2));
                mes = parseInt(fecha.substring(3,5));
                anio = parseInt(fecha.substring(6,10));
                if (dia<1 || dia>31){
                  valido = false;
                }
                if (mes<1 || mes>12){
                  valido = false;
                }

                if (!valido){
                  $("#errores_crear_pizarra").html("*El formato de fecha debe ser dd/mm/yyyy");
                }
                return valido;
              }
              function obtenerFechaActual(){
                var today = new Date();
                var dd = today.getDate();
                var mm = today.getMonth()+1; //January is 0!
                var yyyy = today.getFullYear();
                if(dd<10){
                  dd='0'+dd
                } 
                if(mm<10){
                  mm='0'+mm
                } 
                today = dd+'/'+mm+'/'+yyyy;
                return today;
              }

              function compareDates(date1, date2){
                dia1 = parseInt(date1.substring(0,2));
                mes1 = parseInt(date1.substring(3,5))-1;
                anio1 = parseInt(date1.substring(6,10));
                fecha1 = new Date(anio1,mes1,dia1);

                if (date2 !== obtenerFechaActual()){
                  dia2 = parseInt(date2.substring(0,2));
                  mes2 = parseInt(date2.substring(3,5))-1;
                  anio2 = parseInt(date2.substring(6,10));
                  fecha2 = new Date(anio2,mes2,dia2);

                }
                else{
                  fecha2 = new Date();
                }

                if (fecha1 > fecha2){
                  return -1;
                }
                else if (fecha1 == fecha2){
                  return 0;
                }
                else{
                  return 1;
                }
              }

              function checkEmpty(obj,n){
                if (obj.val().length == 0){
                  $("#errores_crear_pizarra").html("*"+n+" no puede ser vacio");
                  return false;
                }
                return true;
              }

              
              valido = valido && checkLength(nombre,"Nombre",1,50);
              valido = valido && checkLength(descripcion,"Descripcion",1,150);
              valido = valido && checkRegex(nombre,"Nombre",formato);
              valido = valido && checkRegex(descripcion,"Descripcion",formato);
              valido = valido && checkEmpty(fechaini, "Fecha inicio");
              valido = valido && checkEmpty(fechafin, "Fecha final");
              valido = valido && isDate(fechaini);
              valido = valido && isDate(fechafin);
              if (valido && compareDates(fechaini.val(),fechafin.val())==-1){
                valido = false;
                $("#errores_crear_pizarra").html("*La fecha final debe ser mayor a la de inicio");
              }

              today = obtenerFechaActual();

              if (valido && compareDates(fechaini.val(),today)== 1){
                valido = false;
                $("#errores_crear_pizarra").html("*La fecha de inicio debe ser mayor a la de hoy");
              }

              if (valido){
                $("#pizarraForm").submit();
                $(this).dialog("close");
              }
        },
        Cancelar: function(){
          $(this).dialog("close");
        }
      }
      });
  })
  function mifuncion(data){
    alert(data.message);
  }
</script>


      </div>	

      <div id="footer">
        <div id="ano"><a href="">2012 ©</a></div>
        <div id="idioma"><a href="#">Español</a>  |  <a href="#">English</a></div>
      </div>
    </div>
  </body>
